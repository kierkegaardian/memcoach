<div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <div class="prompt-large">{{ card.prompt }}</div>
    {% if card.text_id and card.chunk_index and card.text_total %}
        <p class="text-sm text-gray-600 mb-2">Part {{ card.chunk_index }} of {{ card.text_total }}{% if card.text_title %} ‚Ä¢ {{ card.text_title }}{% endif %}</p>
    {% endif %}
    {% if card.tags %}
        <div class="flex flex-wrap gap-2 mb-4">
            {% for tag in card.tags %}
                <span class="text-xs font-semibold uppercase tracking-wide px-2 py-1 rounded bg-slate-100 text-slate-700">{{ tag }}</span>
            {% endfor %}
        </div>
    {% endif %}
    <form hx-post="/review/submit?kid_id={{ kid_id }}&deck_id={{ deck_id }}&card_id={{ card.id }}{% if group_texts %}&group_texts=1{% endif %}" hx-target="#result" hx-swap="beforeend" class="space-y-4">
        <input type="hidden" name="started_at" value="{{ started_at }}">
        <input type="hidden" name="review_mode" value="{{ review_mode }}">
        {% if group_texts %}
            <input type="hidden" name="group_texts" value="1">
        {% endif %}
        {% if apply_filters %}
            <input type="hidden" name="apply_filters" value="1">
        {% endif %}
        {% if search_query %}
            <input type="hidden" name="q" value="{{ search_query }}">
        {% endif %}
        {% if selected_tags %}
            {% for tag in selected_tags %}
                <input type="hidden" name="tag" value="{{ tag }}">
            {% endfor %}
        {% endif %}
        {% if review_mode == "recitation" %}
            <details class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-blue-900 whitespace-pre-wrap">
                <summary class="cursor-pointer font-semibold">Reveal</summary>
                <div class="mt-2">{{ card.full_text }}</div>
            </details>
            <input type="hidden" name="user_text" value="">
            <div>
                <p class="text-sm font-semibold text-gray-700 mb-2">Parent grade (0‚Äì5)</p>
                <div class="grid grid-cols-3 gap-2 sm:grid-cols-6">
                    {% for score in range(0, 6) %}
                        <button
                            type="submit"
                            name="parent_grade"
                            value="{{ score }}"
                            class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 rounded-lg transition"
                        >
                            {{ score }}
                        </button>
                    {% endfor %}
                </div>
            </div>
        {% elif review_mode == "cloze" %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-blue-900 whitespace-pre-wrap">
                {{ masked_text }}
            </div>
            <textarea name="user_text" placeholder="Fill in what you remember (optional)..." class="recall-textarea w-full h-32 p-4" autocomplete="off"></textarea>
            <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
                <button
                    type="button"
                    class="voice-btn inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-gray-700 hover:bg-gray-50"
                    data-voice-target="user_text"
                >
                    üéôÔ∏è Start voice input
                </button>
                <button
                    type="button"
                    class="voice-local-btn inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-gray-700 hover:bg-gray-50"
                    data-voice-target="user_text"
                >
                    üéß Record & transcribe
                </button>
                <div class="flex flex-col text-xs">
                    <span class="voice-status text-emerald-700 font-medium">Web speech: tap mic to start.</span>
                    <span class="voice-local-status text-slate-500">Local STT: idle.</span>
                    <span class="voice-preview text-gray-500"></span>
                </div>
            </div>
            <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition w-full">Check My Recall</button>
        {% elif review_mode == "first_letters" %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-blue-900 whitespace-pre-wrap">
                {{ initials_text }}
            </div>
            <input type="text" name="user_text" placeholder="Short recall (optional)..." class="recall-textarea w-full p-3" autocomplete="off">
            <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
                <button
                    type="button"
                    class="voice-btn inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-gray-700 hover:bg-gray-50"
                    data-voice-target="user_text"
                >
                    üéôÔ∏è Start voice input
                </button>
                <button
                    type="button"
                    class="voice-local-btn inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-gray-700 hover:bg-gray-50"
                    data-voice-target="user_text"
                >
                    üéß Record & transcribe
                </button>
                <div class="flex flex-col text-xs">
                    <span class="voice-status text-emerald-700 font-medium">Web speech: tap mic to start.</span>
                    <span class="voice-local-status text-slate-500">Local STT: idle.</span>
                    <span class="voice-preview text-gray-500"></span>
                </div>
            </div>
            <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition w-full">Check My Recall</button>
        {% else %}
            <div>
                <label for="hint_mode" class="block text-sm font-semibold text-gray-700 mb-2">Hint mode</label>
                <select
                    id="hint_mode"
                    name="hint_mode"
                    class="w-full border border-gray-300 rounded-lg p-2"
                    hx-get="/review/hint?card_id={{ card.id }}"
                    hx-trigger="change"
                    hx-target="#hint-text"
                    hx-swap="innerHTML"
                >
                    {% for mode_value, mode_label in hint_modes %}
                        <option value="{{ mode_value }}" {% if hint_mode == mode_value %}selected{% endif %}>{{ mode_label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="hint-text" class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-blue-900 whitespace-pre-wrap">
                {% if hint_text %}
                    {{ hint_text }}
                {% else %}
                    No hint is shown for this card.
                {% endif %}
            </div>
            <textarea name="user_text" placeholder="Type what you remember from memory..." class="recall-textarea w-full h-40 p-4" required autocomplete="off"></textarea>
            <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
                <button
                    type="button"
                    class="voice-btn inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-gray-700 hover:bg-gray-50"
                    data-voice-target="user_text"
                >
                    üéôÔ∏è Start voice input
                </button>
                <button
                    type="button"
                    class="voice-local-btn inline-flex items-center gap-2 rounded-lg border border-gray-300 px-3 py-2 text-gray-700 hover:bg-gray-50"
                    data-voice-target="user_text"
                >
                    üéß Record & transcribe
                </button>
                <div class="flex flex-col text-xs">
                    <span class="voice-status text-emerald-700 font-medium">Web speech: tap mic to start.</span>
                    <span class="voice-local-status text-slate-500">Local STT: idle.</span>
                    <span class="voice-preview text-gray-500"></span>
                </div>
            </div>
            <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition w-full">I'm Done - Check My Recall!</button>
        {% endif %}
    </form>
</div>
